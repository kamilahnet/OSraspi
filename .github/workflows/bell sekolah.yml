name: Buildroot_RPi2B_SchoolBell_Full
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev rsync bc wget \
          cpio unzip git perl python3 python3-pip

      - name: Configure and Build
        run: |
          # 1. Reset ke konfigurasi default Raspberry Pi 2
          make raspberrypi2_defconfig

          # 2. Tambahkan kustomisasi secara hati-hati
          # Gunakan sed atau echo dengan format yang benar
          cat >> .config <<EOF
          # SYSTEM
          BR2_TARGET_GENERIC_ROOT_PASSWD="root"
          BR2_SYSTEM_DHCP="eth0"
          BR2_PACKAGE_IFUPDOWN_SCRIPTS=y
          
          # SSH & SFTP
          BR2_PACKAGE_DROPBEAR=y
          BR2_PACKAGE_DROPBEAR_DISABLE_REVERSEDNS=y
          BR2_PACKAGE_OPENSSH_SFTP_SERVER=y

          # TIME
          BR2_PACKAGE_CRONIE=y
          BR2_PACKAGE_NTP=y
          BR2_PACKAGE_NTP_NTPDATE=y

          # MULTIMEDIA & AUDIO
          BR2_PACKAGE_ALSA_UTILS=y
          BR2_PACKAGE_ALSA_UTILS_APLAY=y
          BR2_PACKAGE_GSTREAMER1=y
          BR2_PACKAGE_GST1_PLUGINS_BASE=y
          BR2_PACKAGE_GST1_PLUGINS_BASE_ALSA=y
          BR2_PACKAGE_GST1_PLUGINS_GOOD=y
          BR2_PACKAGE_GST1_PLUGINS_GOOD_RTP=y
          BR2_PACKAGE_GST1_PLUGINS_GOOD_UDP=y
          BR2_PACKAGE_GST1_PLUGINS_BAD=y
          BR2_PACKAGE_GST1_PLUGINS_BAD_FBDEV=y

          # PYTHON & PYGAME
          BR2_PACKAGE_PYTHON3=y
          BR2_PACKAGE_PYTHON_PIP=y
          BR2_PACKAGE_PYTHON_PYGAME=y
          BR2_PACKAGE_PYTHON_PYGAME_IMAGE=y
          BR2_PACKAGE_PYTHON_PYGAME_FONT=y
          BR2_PACKAGE_PYTHON_PYGAME_MIXER=y

          # GUI
          BR2_PACKAGE_NETSURF=y
          BR2_PACKAGE_DEJAVU=y
          BR2_PACKAGE_CANVAS_FONTS=y
          EOF

          # 3. Sinkronisasi ulang konfigurasi untuk membersihkan legacy secara paksa
          make olddefconfig

          # 4. Mulai Build
          make

      - name: Upload SD Card Image
        uses: actions/upload-artifact@v4
        with:
          name: buildroot-rpi2-bell-image
          path: output/images/sdcard.img
