name: Buildroot_RPi2B_SchoolBell_Full
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev rsync bc wget \
          cpio unzip git perl python3 python3-pip
      - name: Configure for Raspberry Pi 2
        run: make raspberrypi2_defconfig

      - name: Customize Config (Full Suite for School Bell)
        run: |
          # Ambil konfigurasi default terlebih dahulu
          make raspberrypi2_defconfig

          # --- SYSTEM & SECURITY ---
          echo "BR2_TARGET_GENERIC_GETTY_PORT=\"tty1\"" >> .config
          echo "BR2_TARGET_GENERIC_ROOT_PASSWD=\"root\"" >> .config
          echo "BR2_PACKAGE_IFUPDOWN_SCRIPTS=y" >> .config
          echo "BR2_SYSTEM_DHCP=\"eth0\"" >> .config
          
          # --- SSH & REMOTE MANAGEMENT ---
          echo "BR2_PACKAGE_DROPBEAR=y" >> .config
          echo "BR2_PACKAGE_DROPBEAR_DISABLE_REVERSEDNS=y" >> .config
          echo "BR2_PACKAGE_OPENSSH_SFTP_SERVER=y" >> .config

          # --- TIME SCHEDULING ---
          echo "BR2_PACKAGE_CRONIE=y" >> .config
          echo "BR2_PACKAGE_NTP=y" >> .config
          echo "BR2_PACKAGE_NTP_NTPDATE=y" >> .config

          # --- PYTHON 3 & LIBRARIES ---
          echo "BR2_PACKAGE_PYTHON3=y" >> .config
          echo "BR2_PACKAGE_PYTHON_PIP=y" >> .config
          echo "BR2_PACKAGE_PYTHON_PYGAME=y" >> .config
          echo "BR2_PACKAGE_PYTHON_PYGAME_IMAGE=y" >> .config
          echo "BR2_PACKAGE_PYTHON_PYGAME_FONT=y" >> .config
          echo "BR2_PACKAGE_PYTHON_PYGAME_MIXER=y" >> .config

          # --- AUDIO & GSTREAMER ---
          echo "BR2_PACKAGE_ALSA_UTILS=y" >> .config
          echo "BR2_PACKAGE_ALSA_UTILS_APLAY=y" >> .config
          echo "BR2_PACKAGE_GSTREAMER1=y" >> .config
          echo "BR2_PACKAGE_GST1_PLUGINS_BASE=y" >> .config
          echo "BR2_PACKAGE_GST1_PLUGINS_BASE_ALSA=y" >> .config
          echo "BR2_PACKAGE_GST1_PLUGINS_GOOD=y" >> .config
          echo "BR2_PACKAGE_GST1_PLUGINS_GOOD_RTP=y" >> .config
          echo "BR2_PACKAGE_GST1_PLUGINS_GOOD_UDP=y" >> .config
          echo "BR2_PACKAGE_GST1_PLUGINS_BAD=y" >> .config
          echo "BR2_PACKAGE_GST1_PLUGINS_BAD_FBDEV=y" >> .config

          # --- GUI & DISPLAY ---
          echo "BR2_PACKAGE_NETSURF=y" >> .config
          echo "BR2_PACKAGE_DEJAVU=y" >> .config
          echo "BR2_PACKAGE_CANVAS_FONTS=y" >> .config

          # --- FIX LEGACY CONFIG ERROR ---
          # Perintah ini akan membuang opsi yang tidak lagi didukung secara otomatis
          make olddefconfig
      - name: Build System
        run: make

      - name: Upload SD Card Image
        uses: actions/upload-artifact@v4
        with:
          name: buildroot-rpi2-bell-image
          path: output/images/sdcard.img
